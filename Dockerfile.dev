#***********************************************
#* This is an autogenerated dev Dockerfile
#* Do not edit this file directly â€” edit deploy-plan.json
#* and re-run the generator.
#***********************************************

# -------- Builder Stage --------
FROM ghcr.io/middle-earth-images/php-alpine:8.4-slim-latest AS builder

USER root



# -----------------------------
# Runtime Stage
# -----------------------------
FROM ghcr.io/middle-earth-images/php-alpine:8.4-slim-latest
ENV SESSION_SECURE_COOKIE=true

# Copy compiled artifacts from builder stage


COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

USER root

# Consolidated RUN layer for minimal image size
RUN \
	apk add --no-cache nodejs npm && \
	apk del --no-cache wget || true && \
	sed -i 's/^upload_max_filesize.*/upload_max_filesize = 20M/' /etc/php84/conf.d/custom.ini && \
	sed -i 's/^post_max_size.*/post_max_size = 100M/' /etc/php84/conf.d/custom.ini && \
	sed -i 's/client_max_body_size .*/client_max_body_size 20M;/' /etc/nginx/nginx.conf && \
	sed -i 's/keepalive_timeout 65/keepalive_timeout 60/' /etc/nginx/nginx.conf && \
	sed -i 's/keepalive_timeout 60;/&\nproxy_read_timeout 60;/' /etc/nginx/nginx.conf && \
	sed -i '/proxy_read_timeout 60;/a\fastcgi_read_timeout 60;' /etc/nginx/nginx.conf && \
	echo 'max_execution_time = 60' >> /etc/php84/conf.d/custom.ini && \
	apk add --no-cache postgresql-client php84-pdo php84-pdo_pgsql php84-pgsql && \
	mkdir -p /etc/php84/conf.d && \
	echo 'extension=pdo_pgsql.so' > /etc/php84/conf.d/20-pdo_pgsql.ini && \
	rm -rf /var/cache/apk/* /usr/share/man/* /usr/share/doc/* /usr/share/info/* /tmp/* /var/tmp/*

USER webuser
